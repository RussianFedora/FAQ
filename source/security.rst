.. Fedora-Faq-Ru (c) 2018, EasyCoding Team and contributors
.. 
.. Fedora-Faq-Ru is licensed under a
.. Creative Commons Attribution-ShareAlike 4.0 International License.
.. 
.. You should have received a copy of the license along with this
.. work. If not, see <https://creativecommons.org/licenses/by-sa/4.0/>.
.. _security:

************************************
Вопросы, связанные с безопасностью
************************************

.. index:: SELinux
.. _selinux:

Что такое SELinux?
========================

SELinux - это мандатная система контроля доступа, ограничивающая доступ ряду сервисов к файлам и каталогам. Больше информации `здесь <https://ru.wikipedia.org/wiki/SELinux>`_.

.. index:: SELinux, disable SELinux, отключение SELinux
.. _selinux-temp:

Как мне временно отключить SELinux?
=======================================

Мы настоятельно не рекомендуем этого делать, но если очень хочется, то для временного отключения достаточно выполнить команду:

.. code-block:: bash

    sudo setenforce 0

Для повторной активации:

.. code-block:: bash

    sudo setenforce 1

Также SELinux можно временно отключить при загрузке системы посредством передачи ядру Linux параметра:

.. code-block:: text

    SELINUX=0

.. index:: SELinux, disable SELinux, отключение SELinux
.. _selinux-disable:

Как мне навсегда отключить SELinux?
=======================================

Достаточно открыть файл конфигурации `/etc/selinux/config` в любом текстовом редакторе и изменить значение директивы `SELINUX`. Допустимые значения:

 * `enforcing` — включён и блокирует всё, что явно не разрешено;
 * `permissive` — включён, но ничего не блокирует и лишь пишет события в системный журнал;
 * `disabled` — полностью отключён.

Изменения вступят в силу при следующей загрузке системы.

.. index:: SELinux, status SELinux, статус SELinux
.. _selinux-status:

Как узнать текущий статус SELinux?
=======================================

При помощи команды **getenforce** или **sestatus**.

.. index:: OpenVPN, SELinux
.. _openvpn-selinux:

OpenVPN не может получить доступ к сертификатам из-за SELinux. Что делать?
==============================================================================

Это нормально ибо запущенные сервисы не могут получать доступ к каталогам пользователя, однако для OpenVPN сделано исключение в виде каталога **~/.cert**.

По умолчанию он не существует, поэтому его нужно создать и задать для него контекст безопасности SELinux:

.. code-block:: bash

    mkdir ~/.cert
    restorecon -Rv ~/.cert

Теперь в нём можно размещать сертификаты и приватные ключи.

.. index:: KPTI, disable migitation
.. _kpti:

Можно ли отключить KPTI?
=======================================

KPTI - это новый механизм ядра, направленный на защиту системы от уязвимости `Meltdown <https://ru.wikipedia.org/wiki/Meltdown_(%D1%83%D1%8F%D0%B7%D0%B2%D0%B8%D0%BC%D0%BE%D1%81%D1%82%D1%8C)>`_ в процессорах Intel. Настоятельно не рекомендуется его отключать, хотя это и возможно. Для этого необходимо и достаточно передать ядру Linux:

.. code-block:: text

    nopti

Параметр **pti=off** также поддерживается в полной мере.

.. index:: spectre, disable migitation
.. _spectrev1:

Можно ли отключить защиту от Spectre v1?
============================================

Нет. Защита от уязвимости Spectre v1 выполняется напрямую микрокодом процессора.

.. index:: spectre, disable migitation
.. _spectrev2:

Можно ли отключить защиту от Spectre v2?
============================================

Да, при помощи параметра ядра:

.. code-block:: text

    nospectre_v2

.. index:: spectre, disable migitation
.. _spectrev4:

Можно ли отключить защиту от Spectre v4?
========================================================================

Да, при помощи параметра ядра:

.. code-block:: text

    nospec_store_bypass_disable

.. index:: L1TF, disable migitation
.. _l1tf:

Можно ли отключить защиту от L1TF?
========================================================================

Да, при помощи параметров ядра:

.. code-block:: text

    l1tf=off

.. index:: hardware vulnerabilities, проверка уязвимостей процессора, CPU
.. _hardware-vuln:

Как узнать защищено ли ядро от известных уязвимостей в процессорах?
========================================================================

Ранее для этого применялись сторонние утилиты, но в современных версиях ядра для этого есть штатный механизм, который можно использовать:

.. code-block:: bash

    grep . /sys/devices/system/cpu/vulnerabilities/*

.. index:: SELinux, SELinux error, ошибки SELinux
.. _selinux-boot-error:

При загрузке получаю ошибку SELinux. Как исправить?
=======================================================

Такое бывает если по какой-то причине сбился контекст безопасности SELinux. Исправить это можно двумя различными способами.

*Способ первый*:

.. code-block:: bash

    sudo touch /.autorelabel
    sudo systemctl reboot

Внимание! Следующая загрузка системы займёт много времени из-за переустановки контекста для всех файлов и каталогов. Ни в коем случае не следует её прерывать. По окончании система автоматически перезагрузится ещё один раз.

*Способ второй*:

.. code-block:: bash

    sudo restorecon -Rv /
    sudo systemctl reboot

После перезагрузки все ошибки, связанные с SELinux, должны исчезнуть.

.. index:: LUKS, encryption, шифрование, USB
.. _luks-usb:

Как можно надёжно зашифровать файлы на USB устройстве?
=========================================================

См. `здесь <https://www.easycoding.org/2016/11/14/shifruem-vneshnij-nakopitel-posredstvom-luks.html>`_.

.. index:: LUKS, encryption, шифрование, home
.. _luks-home:

Можно ли зашифровать домашний раздел уже установленной системы?
==================================================================

См. `здесь <https://www.easycoding.org/2016/12/09/shifruem-domashnij-razdel-ustanovlennoj-sistemy.html>`_.

.. index:: firewalld
.. _firewalld-about:

Что такое Firewalld?
=======================

Firewalld - это современный динамически управляемый брандмауэр с поддержкой зон для интерфейсов.

.. index:: firewalld, настройка firewalld
.. _firewalld-configure:

Как можно настраивать Firewalld?
==================================

Для настройки применяется либо графическая утилита **system-config-firewall**, либо консольная **firewall-cmd**.

Документацию можно `найти в Wiki <https://fedoraproject.org/wiki/FirewallD/ru>`_.

.. index:: firewalld, маскировка сервиса
.. _firewalld-hide-service:

Как замаскировать сервис средствами Firewalld?
=================================================

См. `здесь <https://www.easycoding.org/2017/06/22/maskiruem-opredelyonnyj-servis-sredstvami-firewalld.html>`_.

.. index:: firewalld, block addresses, блокировка IP адресов
.. _firewalld-block:

Как запретить подключения с конкретных IP-адресов?
======================================================

Достаточно добавить их в специально созданную зону **drop** файрвола:

.. code-block:: bash

    firewall-cmd --permanent --zone=drop --add-source=1.2.3.4

Здесь вместо **1.2.3.4** нужно указать необходимый IP-адрес или подсеть (**1.2.3.0/24**).

.. index:: gpg, gnupg, signatures, подписи gpg
.. _gpg-signatures:

Как работать с подписями GnuPG?
==================================

См. `здесь <https://www.easycoding.org/2018/01/11/rabotaem-s-cifrovymi-podpisyami-gpg.html>`_.

.. index:: gpg, encrypt files, зашифровать файлы
.. _gpg-encrypt:

Как зашифровать и расшифровать файлы с определённой маской в текущем каталоге?
==================================================================================

Шифрование всех файлов с маской *.7z.* (многотомные архивы 7-Zip):

.. code-block:: bash

    find . -maxdepth 1 -type f -name "*.7z.*" -exec gpg2 --out "{}.asc" --recipient "example@example.org" --encrypt "{}" \;

Расшифровка:

.. code-block:: bash

    find . -maxdepth 1 -type f -name "*.asc" -exec gpg2 --out "$(basename {})" --decrypt "{}" \;

.. index:: admin, user
.. _admin-vs-user:

Чем отличается пользователь-администратор от обычного?
=========================================================

Администратор (в терминологии программы установки Anaconda) имеет доступ к sudo.

.. index:: admin, sudo
.. _sudo-password:

Какие пароли запрашивают sudo и su?
======================================

Утилита sudo запрашивает текущий пароль пользователя, а su - рутовый.

.. index:: root password, смена пароля root
.. _root-password:

Как мне сменить пароль суперпользователя?
============================================

Для смены или установки пароля суперпользователя при наличии доступа к sudo, можно выполнить:

.. code-block:: bash

    sudo passwd root

.. index:: sudo, доступ к sudo
.. _sudo-access:

Как мне получить доступ к sudo?
==================================

Если при установке Fedora, при создании пользователя, не был установлен флажок в чекбокс **Создать администратора**, то необходимо самостоятельно добавить пользовательский аккаунт в группу **wheel**:

.. code-block:: bash

    su -c "usermod -a -G wheel $(whoami)"

.. index:: sudo, su
.. _sudo-vs-su:

Что лучше: sudo или su?
==========================

Sudo ибо позволяет гибко настраивать права доступа, включая список разрешённых команд, а также ведёт полный журнал её использования.

.. index:: sudo, file manager
.. _sudo-file-manager:

Почему я не могу запустить файловый менеджер с правами суперпользователя?
============================================================================

Это сделано из соображений безопасности. Более подробная информация доступна `здесь <https://blog.martin-graesslin.com/blog/2017/02/editing-files-as-root/>`_.

.. index:: sudo, config editing, редактирование конфигурации
.. _sudo-edit-config:

Как мне отредактировать конфиг, доступный только суперпользователю?
======================================================================

Необходимо использовать **sudoedit**:

.. code-block:: bash

    sudoedit /путь/к/файлу/конфигурации.conf

.. index:: sudo, config editing, редактирование конфигурации
.. _sudoedit-info:

Sudoedit безопаснее прямого запуска текстового редактора с правами суперпользователя?
========================================================================================

Да, намного ибо sudoedit копирует нужный файл во временный каталог и загружает в выбранном по умолчанию текстовом редакторе с обычными правами, а по завершении редактирования копирует на прежнее место.

.. index:: ssh, configuration, настройка ssh
.. _ssh-install:

Как включить и безопасно настроить сервер SSH?
==================================================

Сначала необходимо активировать sshd:

.. code-block:: bash

    sudo systemctl enable sshd.service

Теперь следует открыть конфиг **/etc/ssh/sshd_config** в любом текстовом редакторе и внести правки.

Отключение входа суперпользователем:

.. code-block:: text

    PermitRootLogin no

Запрет входа по паролям (будет доступна лишь аутентификация по ключам):

.. code-block:: text

    PasswordAuthentication no
    PermitEmptyPasswords no

Перезапуск sshd для применения изменений:

.. code-block:: bash

    sudo systemctl restart sshd.service

.. index:: ssh, configuration, настройка ssh, sftp
.. _ssh-sftp:

Можно ли разрешить доступ посредством SSH только к файлам, без возможности выполнения команд?
=================================================================================================

Да. Для этого создадим специальную группу (например **sftp**):

.. code-block:: bash

    sudo groupadd sftp

Откроем конфиг **/etc/ssh/sshd_config** в текстовом редакторе и в самом конце добавим:

.. code-block:: text

    Subsystem sftp internal-sftp
    Match Group sftp
        ChrootDirectory %h
        AllowTCPForwarding no
        ForceCommand internal-sftp

Перезапустим sshd для применения изменений:

.. code-block:: bash

    sudo systemctl restart sshd.service

.. index:: destroy file, shred, уничтожение файла
.. _destroy-file:

Как безвозвратно уничтожить файл?
=====================================

Для уничтожения данных можно использовать штатную утилиту **shred** из пакета GNU Coreutils:

.. code-block:: bash

    shred -u -v /путь/к/файлу.txt

Восстановить такой файл будет практически невозможно ибо сектора диска, на которых он располагался, будут многократно перезаписаны случайной последовательностью, а затем заполнены нулями.

.. index:: destroy disk, shred, уничтожение содержимого накопителя
.. _destroy-disk:

Можно лишь уничтожить содержимое всего диска?
=================================================

Да, для этого можно использовать уже упомянутую выше утилиту **shred**:

.. code-block:: bash

    sudo shred -v /dev/sdX

Здесь **/dev/sdX** — устройство, которое будет очищено. На больших HDD процесс займёт много времени.

.. index:: destroy file, ssd, уничтожение файла на ssd
.. _destroy-ssd-file:

Как уничтожить файл на SSD?
===============================

Для безвозвратного удаления файла на SSD накопителе достаточно просто удалить его штатным средством системы и дождаться выполнения процедуры TRIM, которая физически забьёт ячейки, которые им использовались, нулями.

Если не используется TRIM реального времени, принудительно запустить этот процесс на всех твердотельных накопителях можно так:

.. code-block:: bash

    sudo systemctl start fstrim.service
